---
title: "Symphony - Análise Exploratória de Dados"
author: "Equipe Symphony"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(knitr)
```

# Análise do Dataset de Perfis

## 1. Carregamento dos Dados

```{r load-data}
# Carregar dados
profiles <- read.csv("../data/profiles.csv", stringsAsFactors = FALSE)

# Resumo
cat("Total de perfis:", nrow(profiles), "\n")
cat("Colunas:", ncol(profiles), "\n")

kable(head(profiles, 5), caption = "Primeiras 5 linhas do dataset")
```

## 2. Distribuição por Departamento

```{r dept-distribution}
dept_count <- profiles %>%
  group_by(departamento) %>%
  summarise(n = n()) %>%
  mutate(percentual = round(n / sum(n) * 100, 1))

kable(dept_count, caption = "Distribuição por Departamento")

ggplot(dept_count, aes(x = reorder(departamento, n), y = n, fill = departamento)) +
  geom_col() +
  geom_text(aes(label = paste0(n, " (", percentual, "%)")), hjust = -0.1) +
  coord_flip() +
  theme_minimal() +
  labs(title = "Distribuição de Perfis por Departamento",
       x = "Departamento",
       y = "Quantidade") +
  theme(legend.position = "none")
```

## 3. Distribuição por Cargo

```{r position-distribution}
pos_count <- profiles %>%
  group_by(cargo) %>%
  summarise(n = n()) %>%
  mutate(percentual = round(n / sum(n) * 100, 1))

kable(pos_count, caption = "Distribuição por Cargo")

ggplot(pos_count, aes(x = "", y = n, fill = cargo)) +
  geom_col(width = 1) +
  coord_polar("y") +
  theme_void() +
  labs(title = "Distribuição de Cargos") +
  geom_text(aes(label = paste0(cargo, "\n", percentual, "%")), 
            position = position_stack(vjust = 0.5))
```

## 4. Disponibilidade para Mentoria

```{r mentorship}
mentorship <- profiles %>%
  group_by(disponivel_mentoria) %>%
  summarise(n = n()) %>%
  mutate(percentual = round(n / sum(n) * 100, 1))

kable(mentorship, caption = "Disponibilidade para Mentoria")
```

## 5. Análise de Habilidades

```{r skills}
# Extrair habilidades individuais
all_skills <- profiles %>%
  pull(habilidades) %>%
  str_split(", ") %>%
  unlist() %>%
  str_trim()

skills_count <- data.frame(habilidade = all_skills) %>%
  group_by(habilidade) %>%
  summarise(frequencia = n()) %>%
  arrange(desc(frequencia)) %>%
  head(10)

kable(skills_count, caption = "Top 10 Habilidades Mais Comuns")

ggplot(skills_count, aes(x = reorder(habilidade, frequencia), y = frequencia)) +
  geom_col(fill = "#667eea") +
  coord_flip() +
  theme_minimal() +
  labs(title = "Top 10 Habilidades",
       x = "Habilidade",
       y = "Frequência")
```

## 6. Métrica de Fairness Básica

```{r fairness}
# Distribuição de mentores por departamento
mentors_by_dept <- profiles %>%
  filter(disponivel_mentoria == TRUE) %>%
  group_by(departamento) %>%
  summarise(mentores = n()) %>%
  left_join(dept_count %>% select(departamento, total = n), by = "departamento") %>%
  mutate(percentual_mentores = round(mentores / total * 100, 1))

kable(mentors_by_dept, caption = "Distribuição de Mentores por Departamento")

ggplot(mentors_by_dept, aes(x = departamento, y = percentual_mentores, fill = departamento)) +
  geom_col() +
  geom_hline(yintercept = 50, linetype = "dashed", color = "red") +
  theme_minimal() +
  labs(title = "% de Mentores por Departamento",
       subtitle = "Linha vermelha = 50% (ideal de equilíbrio)",
       x = "Departamento",
       y = "% de Mentores") +
  theme(legend.position = "none")
```

### Interpretação de Fairness

```{r fairness-interpretation}
cat("\n=== Análise de Equidade ===\n\n")

# Calcular disparate impact simples
mentor_rates <- mentors_by_dept$percentual_mentores
min_rate <- min(mentor_rates)
max_rate <- max(mentor_rates)
disparate_impact <- min_rate / max_rate

cat("Taxa mínima de mentores:", min_rate, "%\n")
cat("Taxa máxima de mentores:", max_rate, "%\n")
cat("Disparate Impact:", round(disparate_impact, 3), "\n\n")

if (disparate_impact >= 0.8) {
  cat("✅ APROVADO: Disparate Impact >= 0.8 (sem viés significativo)\n")
} else {
  cat("⚠️ ATENÇÃO: Disparate Impact < 0.8 (possível viés entre departamentos)\n")
}
```

## 7. Conclusões

- Dataset com **`r nrow(profiles)` perfis** distribuídos em **`r length(unique(profiles$departamento))` departamentos**
- **`r sum(profiles$disponivel_mentoria == TRUE)` mentores disponíveis** (`r round(sum(profiles$disponivel_mentoria == TRUE) / nrow(profiles) * 100, 1)`%)
- Habilidade mais comum: **`r skills_count$habilidade[1]`** (aparece `r skills_count$frequencia[1]` vezes)
- Fairness: Disparate Impact = **`r round(disparate_impact, 3)`** (objetivo: ≥ 0.8)

**Recomendação para produção:** Monitorar distribuição de matches entre departamentos para garantir conexões interdepartamentais e evitar silos.
